<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Bloc 3 - Transaction Simulator</title>
    <style>
       
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height: 60px;">
                <h1>LBP Simulateur de transaction</h1>
            </div>
            <p class="subtitle">D√©tection de fraude temps-r√©el avec MLFlow</p>
        </header>

        <div class="controls">
            <h2 style="margin-bottom: 20px;">Gestion des paiements</h2>
            <div class="button-group">
                <button class="btn-secondary" onclick="simulateTransaction(false)">
                    üí≥ Simuler une transaction
                </button>
                <!-- <button class="btn-danger" onclick="simulateTransaction(true)">
                    üö® Simuler une transaction frauduleuse
                </button> -->
                <button class="btn-primary" onclick="simulateBatch()" id="loopTransaction">
                    üìä Simuler des transactions en continu
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none; "></div>
            ‚è≥ Transaction en cours d'analyse...
        </div>

        <div id="result" class="result-container"></div>
    </div>

    <script>

        const currentTime = new Date().toLocaleString();

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').classList.remove('show');
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }


        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            const isFraud = data.prediction.is_fraud;
            const cardClass = isFraud ? 'fraud-detected' : 'fraud-safe';
            const badgeClass = isFraud ? 'badge-fraud' : 'badge-safe';
            const badgeText = isFraud ? 'üö® Fraude d√©tect√©e' : '‚úÖ Transaction conforme';

            const currentTime = new Date().toLocaleTimeString();
            if (!data.success) {
                resultDiv.innerHTML = `
                    <h2 style="color: #FF4136;">‚ùå Erreur n¬∞${data.error_code}</h2>
                    <h3>Heure actuelle: ${currentTime}</h3>
                    <p>${data.error}</p>
                    
                `;
                resultDiv.classList.add('show');
                return;
            }

            resultDiv.innerHTML = `

                                    <h2>R√©sultat de la transaction</h2>
                    <div class="transaction-card ${cardClass}">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <span class="fraud-badge ${badgeClass}">${badgeText}</span>
                        </div>

                        <div class="detail-row">
                            <span class="label">Transaction ID:</span>
                            <span class="value">${data.transaction.id}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Amount:</span>
                            <span class="value">$${data.transaction.amount.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Merchant:</span>
                            <span class="value">${data.transaction.merchant}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Category:</span>
                            <span class="value">${data.transaction.category}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Location:</span>
                            <span class="value">${data.transaction.city}, ${data.transaction.state}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Date:</span>
                            <span class="value">${data.transaction.date}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Saved to Database:</span>
                            <span class="value">${data.transaction.saved_to_db ? '‚úÖ Oui' : '‚ùå Non'}</span>
                        </div>
                    </div>







                <h3 style="margin-top: 30px;">Transactions:</h3>
              
            `;

            resultDiv.classList.add('show');
        }

        async function simulateTransaction(forceFraud) {
            showLoading();

            try {
                const response = await fetch('/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force_fraud: forceFraud
                    })
                });

                const data = await response.json();
                hideLoading();

                console.info('Response data:', data);
               
                if (!data.success) {
                            displayResult({
                                success: false,
                                error: data.error || 'Unknown error',
                                error_code: data.error_code || 'UNKNOWN'
                            });
                            return;
                }
                if (data.db_warning) {
                    console.warn('Database warning:', data.db_warning);
                }  
                displayResult(data);                              

            } catch (error) {
                console.error('Network error:', error);
                hideLoading();
                displayResult({
                    success: false,
                    error: `Network error: ${error.message}`,
                    error_code: 'NETWORK'
                });
            }
        }

        async function simulateBatch() {
            const runBatch = async () => {
            showLoading();

            try {
                const response = await fetch('/simulate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    count: 1,
                    fraud_rate: 0
                })
                });

                const data = await response.json();
                hideLoading();
                displayResult(data);

            } catch (error) {
                hideLoading();
                displayResult({
                success: false,
                error: `Network error: ${error.message}`
                });
            }
            };

            // Run immediately
            runBatch();

            // Then repeat every 30 seconds
            setInterval(runBatch, 30000);
        }


        let isLooping = false;

        function toggleLoop() {
            const button = document.getElementById('loopTransaction');
            if (isLooping) {
                clearInterval(window.batchInterval);
                button.textContent = 'üìä Simuler transactions en continue';
            } else {
                simulateBatch();
                button.textContent = '‚è∏Ô∏è Arr√™ter les transactions';
            }
            isLooping = !isLooping;
        }

        document.getElementById('loopTransaction').addEventListener('click', toggleLoop);

        // Auto-load on page load
        window.addEventListener('load', function() {
            console.log('Transaction Simulator Ready');
        });
    </script>
</body>
</html>
