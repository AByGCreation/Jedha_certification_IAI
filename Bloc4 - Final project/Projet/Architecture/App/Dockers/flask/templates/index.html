<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="style.css"> -->
    <title>Bloc 3 - Transaction Simulator</title>
    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  /*background: linear-gradient(135deg, #DFF4F5 0%, #89C2FF 100%);*/
  background: #dff4f5;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  background: #170035;
  color: white;
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 30px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

h1 {
  font-size: 2.5em;
  margin-bottom: 10px;
}

.subtitle {
  color: #3ae5ff;
  font-size: 1.2em;
}

.controls {
  background: white;
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 30px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.button-group {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

button {
  padding: 15px 30px;
  font-size: 1.1em;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: bold;
}

.btn-primary {
  background: #8409ff;
  color: white;
}

.btn-primary:hover {
  background: #6b07cc;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(132, 9, 255, 0.3);
}

.btn-danger {
  background: #ff4136;
  color: white;
}

.btn-danger:hover {
  background: #cc342b;
  transform: translateY(-2px);
}

.btn-secondary {
  background: #3ae5ff;
  color: #170035;
}

.btn-secondary:hover {
  background: #2bc4db;
}

.result-container {
  background: white;
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  display: none;
}

.result-container.show {
  display: block;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.transaction-card {
  border-left: 5px solid #8409ff;
  padding: 20px;
  margin-bottom: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.fraud-detected {
  border-left-color: #ff4136;
  background: #ffe6e6;
}

.fraud-safe {
  border-left-color: #2ecc40;
  background: #e6ffe6;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #ddd;
}

.detail-row:last-child {
  border-bottom: none;
}

.label {
  font-weight: bold;
  color: #170035;
}

.value {
  color: #666;
}

.fraud-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 1.1em;
}

.badge-fraud {
  background: #ff4136;
  color: white;
}

.badge-safe {
  background: #2ecc40;
  color: white;
}

.loading {
  text-align: center;
  padding: 20px;
  font-size: 1.2em;
  color: #8409ff;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.stat-card {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

.stat-value {
  font-size: 2em;
  font-weight: bold;
  color: #8409ff;
}

.stat-label {
  color: #666;
  margin-top: 5px;
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="https://www.labanquepostale.com/content/dam/lbp/iconographie/assets-specifiques/logos-group/lbp/light/vignette-logo-lbp.png" alt="Logo" style="height: 60px;">
                <h1>LBP Simulateur de transaction</h1>
            </div>
            <p class="subtitle">D√©tection de fraude temps-r√©el avec MLFlow</p>
        </header>

        <div class="controls">
            <h2 style="margin-bottom: 20px;">Gestion des paiements</h2>
            <div class="button-group">
                <button class="btn-secondary" onclick="simulateTransaction(false)">
                    üí≥ Simuler une transaction
                </button>
                <!-- <button class="btn-danger" onclick="simulateTransaction(true)">
                    üö® Simuler une transaction frauduleuse
                </button> -->
                <button class="btn-primary" onclick="toggleLoop()" id="loopTransaction">
                    üìä Simuler des transactions en continu
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none; ">
            ‚è≥ Transaction en cours d'analyse...
        </div>

        <div id="result" class="result-container"></div>
    </div>

    <script>

        const currentTime = new Date().toLocaleString();

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').classList.remove('show');
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }


        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            const isFraud = data.prediction.is_fraud;
            const cardClass = isFraud ? 'fraud-detected' : 'fraud-safe';
            const badgeClass = isFraud ? 'badge-fraud' : 'badge-safe';
            const badgeText = isFraud ? 'üö® Fraude d√©tect√©e' : '‚úÖ Transaction conforme';

            const currentTime = new Date().toLocaleTimeString();
            if (!data.success) {
                resultDiv.innerHTML = `
                    <h2 style="color: #FF4136;">‚ùå Erreur n¬∞${data.error_code}</h2>
                    <h3>Heure actuelle: ${currentTime}</h3>
                    <p>${data.error}</p>
                    
                `;
                resultDiv.classList.add('show');
                return;
            }

            resultDiv.innerHTML = `

                 <h2>R√©sultat de la pr√©diction</h2>
                    <div class="transaction-card ${cardClass}">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <span class="fraud-badge ${badgeClass}">${badgeText}</span>
                        </div>

                        <div class="detail-row">
                            <span class="label">ID de la transaction:</span>
                            <span class="value">${data.transaction.id}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Montant:</span>
                            <span class="value">$${data.transaction.amount.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Marchand:</span>
                            <span class="value">${data.transaction.merchant}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Cat√©gorie:</span>
                            <span class="value">${data.transaction.category}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Localisation:</span>
                            <span class="value">${data.transaction.city}, ${data.transaction.state}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Date:</span>
                            <span class="value">${new Date(parseInt(data.transaction.date)).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Sauvegard√©:</span>
                            <span class="value">${data.saved_to_db ? '‚úÖ Oui' : '‚ùå Non'}</span>
                        </div>
                    </div>

              
            `;

            resultDiv.classList.add('show');
        }

        async function simulateTransaction(forceFraud) {
            showLoading();

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds timeout
                
                const response = await fetch('/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force_fraud: forceFraud
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();
                hideLoading();

                console.info('Response data:', data);
               
                if (!data.success) {
                            displayResult({
                                success: false,
                                error: data.error || 'Unknown error',
                                error_code: data.error_code || 'UNKNOWN'
                            });
                            return;
                }
                if (data.db_warning) {
                    console.warn('Database warning:', data.db_warning);
                }  
                displayResult(data);                              

            } catch (error) {
                console.error('Network error:', error);
                hideLoading();
                displayResult({
                    success: false,
                    error: `Network error: ${error.message}`,
                    error_code: 'NETWORK'
                });
            }
        }

        async function simulateBatch() {
            const runBatch = async () => {
            showLoading();

            try {
                const response = await fetch('/simulate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    count: 1,
                    fraud_rate: 0
                })
                });

                const data = await response.json();
                hideLoading();
                displayResult(data);

            } catch (error) {
                hideLoading();
                displayResult({
                success: false,
                error: `Network error: ${error.message}`
                });
            }
            };

            // Run immediately
            runBatch();

            // Then repeat every 20 seconds
            setInterval(runBatch, 20000);
        }


        let isLooping = false;

        // function toggleLoop() {
        //     const button = document.getElementById('loopTransaction');
        //     if (isLooping) {
        //         clearInterval(window.batchInterval);
        //         isLooping = false;
        //         button.textContent = 'üìä Simuler transactions en continue';
        //     } else {
        //         simulateBatch();
        //         button.textContent = '‚è∏Ô∏è Arr√™ter les transactions';
        //     }
        //     isLooping = !isLooping;
        


        // }









                let batchInterval;

        function toggleLoop() {
            const button = document.getElementById('loopTransaction');
            if (isLooping) {
                clearInterval(batchInterval);
                isLooping = false;
                button.textContent = 'üìä Simuler des transactions en continu';
            } else {
                runBatch();
                batchInterval = setInterval(runBatch, 20000);
                button.textContent = '‚è∏Ô∏è Arr√™ter les transactions';
                isLooping = true;
            }
        }

        async function runBatch() {
            showLoading();
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 80000); // 80 seconds timeout
                
                const response = await fetch('/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        count: 1,
                        fraud_rate: 0
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const data = await response.json();
                hideLoading();
                displayResult(data);
            } catch (error) {
                hideLoading();
                displayResult({
                    success: false,
                    error: `Network error: ${error.message}`
                });
            }
        }
        
        document.getElementById('loopTransaction').addEventListener('click', toggleLoop);

        // Auto-load on page load
        window.addEventListener('load', function() {
            console.log('Transaction Simulator Ready');
        });
    </script>
</body>
</html>
